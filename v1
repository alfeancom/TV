//@version=5
strategy("ALVE Strategy - Futures", overlay=true,
         pyramiding=0, // Jangan tambahkan posisi jika sudah ada posisi terbuka
         initial_capital=10000, // Modal awal untuk backtesting
         default_qty_type=strategy.percent_of_equity, // Tipe ukuran posisi: persentase ekuitas
         default_qty_value=10, // 10% dari ekuitas per perdagangan
         commission_type=strategy.commission.percent, // Tipe komisi: persentase
         commission_value=0.07 // Contoh: 0.07% komisi per perdagangan
         )

// --- Input Pengguna untuk Konfigurasi Strategi ---

// Input Moving Average
lengthFastMA = input.int(10, title="Panjang MA Cepat", minval=1)
lengthSlowMA = input.int(30, title="Panjang MA Lambat", minval=1)
maType = input.string("SMA", title="Tipe MA", options=["SMA", "EMA", "WMA"])

// Input RSI
lengthRSI = input.int(14, title="Panjang RSI", minval=1)
levelRSIBuy = input.float(60, title="Level RSI Beli (di atas)", minval=0, maxval=100) // Dioptimalkan: Lebih tinggi untuk momentum lebih kuat
levelRSISell = input.float(40, title="Level RSI Jual (di bawah)", minval=0, maxval=100) // Dioptimalkan: Lebih rendah untuk momentum lebih kuat

// Input Volume Konfirmasi
volumeLookback = input.int(20, title="Periode Rata-rata Volume", minval=1)
volumeMultiplier = input.float(2.0, title="Pengali Volume Konfirmasi (x Rata-rata)", minval=1.0) // Dioptimalkan: Volume lebih tinggi diperlukan

// Input untuk Stop Loss & Take Profit (Sangat Penting untuk Manajemen Risiko)
useStopLoss = input.bool(true, title="Gunakan Stop Loss")
stopLossPercent = input.float(2.0, title="Stop Loss (%)", minval=0.1, maxval=100) / 100 // Konversi ke desimal
useTakeProfit = input.bool(true, title="Gunakan Take Profit")
takeProfitPercent = input.float(4.0, title="Take Profit (%)", minval=0.1, maxval=100) / 100 // Konversi ke desimal

// --- Perhitungan Indikator ---

// Pemilihan tipe Moving Average
var float fastMA = na
var float slowMA = na

if maType == "SMA"
    fastMA := ta.sma(close, lengthFastMA)
    slowMA := ta.sma(close, lengthSlowMA)
else if maType == "EMA"
    fastMA := ta.ema(close, lengthFastMA)
    slowMA := ta.ema(close, lengthSlowMA)
else if maType == "WMA"
    fastMA := ta.wma(close, lengthFastMA)
    slowMA := ta.wma(close, lengthSlowMA)

// Perhitungan RSI
rsi = ta.rsi(close, lengthRSI)

// Perhitungan Rata-rata Volume
avgVolume = ta.sma(volume, volumeLookback) // Rata-rata volume sederhana

// --- Deteksi Pola Tren Sederhana (Menggunakan MA yang Sedang Naik/Turun) ---
// Dioptimalkan: Deteksi tren lebih robust dengan melihat MA yang sedang naik/turun selama beberapa bar
isUptrending = ta.rising(fastMA, 3) // Fast MA naik selama 3 bar
isDowntrending = ta.falling(fastMA, 3) // Fast MA turun selama 3 bar

// --- Kondisi Sinyal Masuk ---

// Kondisi dasar MA Crossover
longConditionBase = ta.crossover(fastMA, slowMA)
shortConditionBase = ta.crossunder(fastMA, slowMA)

// Konfirmasi RSI
longRSIConfirm = rsi > levelRSIBuy
shortRSIConfirm = rsi < levelRSISell

// Konfirmasi Volume: Volume saat ini harus lebih tinggi dari rata-rata volume (dikalikan pengali)
longVolumeConfirm = volume > (avgVolume * volumeMultiplier)
shortVolumeConfirm = volume > (avgVolume * volumeMultiplier)

// Gabungan Semua Kondisi untuk Sinyal LONG
// Sinyal LONG jika MA crossover positif, RSI di atas level beli, volume tinggi, DAN tren adalah uptrending
longCondition = longConditionBase and longRSIConfirm and longVolumeConfirm and isUptrending

// Gabungan Semua Kondisi untuk Sinyal SHORT
// Sinyal SHORT jika MA crossover negatif, RSI di bawah level jual, volume tinggi, DAN tren adalah downtrending
shortCondition = shortConditionBase and shortRSIConfirm and shortVolumeConfirm and isDowntrending

// --- Eksekusi Order (Hanya untuk Backtesting) ---
var float entryPrice = na
var bool activeLongSignal = false // Melacak sinyal long aktif
var bool activeShortSignal = false // Melacak sinyal short aktif

if longCondition and strategy.position_size == 0 // Hanya masuk jika tidak ada posisi terbuka
    strategy.entry("Long", strategy.long)
    entryPrice := close // Simpan harga masuk untuk SL/TP
    activeLongSignal := true
    activeShortSignal := false // Pastikan sinyal short tidak aktif

if shortCondition and strategy.position_size == 0 // Hanya masuk jika tidak ada posisi terbuka
    strategy.entry("Short", strategy.short)
    entryPrice := close // Simpan harga masuk untuk SL/TP
    activeShortSignal := true
    activeLongSignal := false // Pastikan sinyal long tidak aktif

// Reset sinyal aktif saat posisi ditutup
if strategy.position_size == 0
    activeLongSignal := false
    activeShortSignal := false

// --- Penempatan Stop Loss dan Take Profit ---
// Stop Loss untuk posisi Long
if useStopLoss and strategy.position_size > 0
    longStopPrice = entryPrice * (1 - stopLossPercent)
    longTakeProfitPrice = entryPrice * (1 + takeProfitPercent)
    strategy.exit("Exit Long SL/TP", from_entry="Long", stop=longStopPrice, limit=longTakeProfitPrice)

// Stop Loss untuk posisi Short
if useStopLoss and strategy.position_size < 0
    shortStopPrice = entryPrice * (1 + stopLossPercent)
    shortTakeProfitPrice = entryPrice * (1 - takeProfitPercent)
    strategy.exit("Exit Short SL/TP", from_entry="Short", stop=shortStopPrice, limit=shortTakeProfitPrice)

// --- Visualisasi di Chart ---
// Plot Moving Average di grafik utama
plot(fastMA, color=color.rgb(0, 150, 255), title="MA Cepat", linewidth=2) // Warna biru muda, tebal
plot(slowMA, color=color.rgb(255, 0, 0), title="MA Lambat", linewidth=2) // Warna merah, tebal

// Plot sinyal masuk (panah di bawah/atas bar) dengan teks "LONG" atau "SHORT"
plotshape(longCondition, style=shape.triangleup, location=location.belowbar, color=color.new(color.green, 0), size=size.small, title="Sinyal LONG", text="LONG", textcolor=color.white)
plotshape(shortCondition, style=shape.triangledown, location=location.abovebar, color=color.new(color.red, 0), size=size.small, title="Sinyal SHORT", text="SHORT", textcolor=color.white)

// --- Menambahkan Informasi Sinyal Berkelanjutan ---
var label currentStatusLabel = na // Inisialisasi label
string statusText = ""
color statusColor = color.gray

// Menentukan teks dan warna status berdasarkan kondisi pasar atau posisi aktif
if strategy.position_size > 0 // Jika sedang posisi LONG
    statusText := "Posisi: LONG (" + str.tostring(strategy.position_avg_price, "#.##") + ")\n" +
                  "Status: Tren Naik Konfirmasi Kuat"
    statusColor := color.new(color.green, 20)
else if strategy.position_size < 0 // Jika sedang posisi SHORT
    statusText := "Posisi: SHORT (" + str.tostring(strategy.position_avg_price, "#.##") + ")\n" +
                  "Status: Tren Turun Konfirmasi Kuat"
    statusColor := color.new(color.red, 20)
else // Jika tidak ada posisi terbuka
    if longCondition // Jika ada sinyal LONG baru, tunjukkan itu
        statusText := "Sinyal LONG Baru!"
        statusColor := color.new(color.green, 0) // Tidak transparan untuk sinyal baru
    else if shortCondition // Jika ada sinyal SHORT baru, tunjukkan itu
        statusText := "Sinyal SHORT Baru!"
        statusColor := color.new(color.red, 0) // Tidak transparan untuk sinyal baru
    else if isUptrending and rsi > 50 // Potensi LONG: Tren naik, RSI positif
        statusText := "Potensi LONG:\n" +
                      "Tren: Naik (MA Naik)\n" +
                      "RSI: Bullish (" + str.tostring(rsi, "#.##") + ")"
        statusColor := color.new(color.lime, 70) // Lebih transparan untuk potensi
    else if isDowntrending and rsi < 50 // Potensi SHORT: Tren turun, RSI negatif
        statusText := "Potensi SHORT:\n" +
                      "Tren: Turun (MA Turun)\n" +
                      "RSI: Bearish (" + str.tostring(rsi, "#.##") + ")"
        statusColor := color.new(color.fuchsia, 70) // Lebih transparan untuk potensi
    else // Netral
        statusText := "Netral:\n" +
                      "Menunggu Konfirmasi Sinyal"
        statusColor := color.new(color.gray, 70)

// Membuat atau memperbarui label status berkelanjutan di pojok kiri atas
if na(currentStatusLabel)
    currentStatusLabel := label.new(x=bar_index, y=high, text=statusText, color=statusColor, textcolor=color.white, style=label.style_label_down, size=size.normal)
else
    label.set_text(currentStatusLabel, statusText)
    label.set_x(currentStatusLabel, bar_index)
    label.set_y(currentStatusLabel, high) // Bisa disesuaikan posisinya
    label.set_color(currentStatusLabel, statusColor)

// --- Plot RSI dan Volume di Panel Terpisah (Jika Diinginkan) ---
// Untuk melihat RSI di panel terpisah (bukan di grafik utama), Anda harus menambahkan ini secara manual
// di TradingView setelah menambahkan script.
// Klik kanan pada chart -> Add Indicator -> Cari nama script Anda -> Klik pada ikon panah untuk memilih 'Add to New Pane'
//
// plot(rsi, title="RSI", color=color.purple)
// plot(avgVolume, title="Avg Volume", color=color.orange)
